<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- Default Configuration if not set -->
    <Configuration Condition="'$(Configuration)' == ''">Debug</Configuration>
    <!-- Determine the path to the build tasks DLL -->
    <!-- Default to the local build output; packaged/alternative setups should override AvalazorBuildTasksPath externally -->
    <AvalazorBuildTasksPath Condition="'$(AvalazorBuildTasksPath)' == ''">$(MSBuildThisFileDirectory)..\bin\$(Configuration)\net8.0\Avalazor.Build.dll</AvalazorBuildTasksPath>
    <AvalazorGeneratedPath Condition="'$(AvalazorGeneratedPath)' == ''">$(IntermediateOutputPath)Avalazor\Generated\</AvalazorGeneratedPath>
  </PropertyGroup>

  <!-- UsingTask declarations - assembly will be loaded when tasks are executed -->
  <!-- MSBuild 16.0+ automatically uses isolated loading when a .deps.json file is present. The PrivateAssets="all" attribute on ProjectReferences in the .csproj ensures this .deps.json includes all dependencies used by these tasks. -->
  <UsingTask TaskName="Avalazor.Build.TranspileRazorTask" AssemblyFile="$(AvalazorBuildTasksPath)" />
  <UsingTask TaskName="Avalazor.Build.CompileScssTask" AssemblyFile="$(AvalazorBuildTasksPath)" />

  <ItemGroup>
    <!-- Include all .razor files -->
    <AvalazorRazorFiles Include="**\*.razor" Exclude="$(BaseIntermediateOutputPath)**;$(BaseOutputPath)**;bin\**;obj\**" />
    <!-- Include all .scss files -->
    <AvalazorScssFiles Include="**\*.scss" Exclude="$(BaseIntermediateOutputPath)**;$(BaseOutputPath)**;bin\**;obj\**" />
  </ItemGroup>

  <!-- Transpile Razor files before BeforeCompile (earlier than CoreCompile) -->
  <Target Name="AvalazorTranspileRazor" 
          BeforeTargets="BeforeCompile;ResolveReferences" 
          DependsOnTargets="ResolveProjectReferences"
          Inputs="@(AvalazorRazorFiles)" 
          Outputs="$(AvalazorGeneratedPath)razor.stamp" 
          Condition="'@(AvalazorRazorFiles)' != '' AND Exists('$(AvalazorBuildTasksPath)')">
    <!-- Note: Exists() check is defensive - DLL should exist due to DependsOnTargets="ResolveProjectReferences" -->
    <Message Importance="High" Text="Avalazor: Transpiling @(AvalazorRazorFiles->Count()) Razor file(s)..." />
    <MakeDir Directories="$(AvalazorGeneratedPath)" />
    
    <TranspileRazorTask 
      RazorFiles="@(AvalazorRazorFiles)"
      RootNamespace="$(RootNamespace)"
      OutputPath="$(AvalazorGeneratedPath)"
      UseFolderNamespacing="true">
      <Output TaskParameter="GeneratedFiles" ItemName="AvalazorGeneratedRazor" />
    </TranspileRazorTask>

    <!-- Add generated files to compilation -->
    <ItemGroup>
      <Compile Include="@(AvalazorGeneratedRazor)" />
    </ItemGroup>

    <Touch Files="$(AvalazorGeneratedPath)razor.stamp" AlwaysCreate="true" />
  </Target>

  <!-- Compile SCSS files before Build -->
  <Target Name="AvalazorCompileScss" BeforeTargets="Build" Inputs="@(AvalazorScssFiles)" Outputs="$(AvalazorGeneratedPath)scss.stamp" Condition="'@(AvalazorScssFiles)' != '' AND Exists('$(AvalazorBuildTasksPath)')">
    <Message Importance="High" Text="Avalazor: Compiling @(AvalazorScssFiles->Count()) SCSS file(s)..." />
    <MakeDir Directories="$(AvalazorGeneratedPath)css\" />
    
    <CompileScssTask 
      ScssFiles="@(AvalazorScssFiles)"
      OutputPath="$(AvalazorGeneratedPath)css\"
      IncludePaths="$(MSBuildProjectDirectory)">
      <Output TaskParameter="GeneratedFiles" ItemName="AvalazorGeneratedCss" />
    </CompileScssTask>

    <!-- Copy CSS files to output -->
    <ItemGroup>
      <Content Include="@(AvalazorGeneratedCss)">
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      </Content>
    </ItemGroup>

    <Touch Files="$(AvalazorGeneratedPath)scss.stamp" AlwaysCreate="true" />
  </Target>

  <!-- Clean generated files -->
  <Target Name="AvalazorCleanGenerated" BeforeTargets="Clean">
    <RemoveDir Directories="$(AvalazorGeneratedPath)" />
  </Target>

</Project>
