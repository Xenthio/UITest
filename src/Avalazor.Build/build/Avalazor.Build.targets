<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- Default Configuration if not set -->
    <Configuration Condition="'$(Configuration)' == ''">Debug</Configuration>
    <!-- Determine the path to the build tasks DLL -->
    <!-- Default to the local build output; packaged/alternative setups should override AvalazorBuildTasksPath externally -->
    <AvalazorBuildTasksPath Condition="'$(AvalazorBuildTasksPath)' == ''">$(MSBuildThisFileDirectory)..\bin\$(Configuration)\net8.0\Avalazor.Build.dll</AvalazorBuildTasksPath>
    <AvalazorGeneratedPath Condition="'$(AvalazorGeneratedPath)' == ''">$(IntermediateOutputPath)Avalazor\Generated\</AvalazorGeneratedPath>
    <!-- Path to the themes folder - can be overridden by projects -->
    <AvalazorThemesPath Condition="'$(AvalazorThemesPath)' == ''">$(MSBuildThisFileDirectory)..\..\..\themes\</AvalazorThemesPath>
  </PropertyGroup>

  <!-- UsingTask declarations - assembly will be loaded when tasks are executed -->
  <!-- MSBuild 16.0+ automatically uses isolated loading when a .deps.json file is present. The PrivateAssets="all" attribute on ProjectReferences in the .csproj ensures this .deps.json includes all dependencies used by these tasks. -->
  <UsingTask TaskName="Avalazor.Build.TranspileRazorTask" AssemblyFile="$(AvalazorBuildTasksPath)" />

  <ItemGroup>
    <!-- Include all .razor files -->
    <AvalazorRazorFiles Include="**\*.razor" Exclude="$(BaseIntermediateOutputPath)**;$(BaseOutputPath)**;bin\**;obj\**" />
    <!-- Include all .scss files for copying to output -->
    <AvalazorScssFiles Include="**\*.scss" Exclude="$(BaseIntermediateOutputPath)**;$(BaseOutputPath)**;bin\**;obj\**" />
    <!-- Include theme SCSS files from the themes folder -->
    <AvalazorThemeFiles Include="$(AvalazorThemesPath)**\*.scss" Condition="Exists('$(AvalazorThemesPath)')" />
  </ItemGroup>

  <!-- Transpile Razor files before BeforeCompile (earlier than CoreCompile) -->
  <Target Name="AvalazorTranspileRazor" 
          BeforeTargets="BeforeCompile;ResolveReferences" 
          DependsOnTargets="ResolveProjectReferences"
          Inputs="@(AvalazorRazorFiles)" 
          Outputs="$(AvalazorGeneratedPath)razor.stamp" 
          Condition="'@(AvalazorRazorFiles)' != '' AND Exists('$(AvalazorBuildTasksPath)')">
    <!-- Note: Exists() check is defensive - DLL should exist due to DependsOnTargets="ResolveProjectReferences" -->
    <Message Importance="High" Text="Avalazor: Transpiling @(AvalazorRazorFiles->Count()) Razor file(s)..." />
    <MakeDir Directories="$(AvalazorGeneratedPath)" />
    
    <TranspileRazorTask 
      RazorFiles="@(AvalazorRazorFiles)"
      RootNamespace="$(RootNamespace)"
      OutputPath="$(AvalazorGeneratedPath)"
      UseFolderNamespacing="true">
      <Output TaskParameter="GeneratedFiles" ItemName="AvalazorGeneratedRazor" />
    </TranspileRazorTask>

    <!-- Add generated files to compilation -->
    <ItemGroup>
      <Compile Include="@(AvalazorGeneratedRazor)" />
    </ItemGroup>

    <Touch Files="$(AvalazorGeneratedPath)razor.stamp" AlwaysCreate="true" />
  </Target>

  <!-- Copy SCSS source files to output directory for runtime loading by StyleParser -->
  <Target Name="AvalazorCopyScssToOutput" AfterTargets="Build">
    <ItemGroup>
      <AvalazorScssContent Include="@(AvalazorScssFiles)" />
    </ItemGroup>
    <Copy SourceFiles="@(AvalazorScssContent)" DestinationFolder="$(OutputPath)%(RecursiveDir)" SkipUnchangedFiles="true" />
    <Message Importance="High" Text="Avalazor: Copied @(AvalazorScssContent->Count()) SCSS file(s) to output" Condition="'@(AvalazorScssContent)' != ''" />
  </Target>

  <!-- Copy theme SCSS files to output directory -->
  <Target Name="AvalazorCopyThemesToOutput" AfterTargets="Build" Condition="Exists('$(AvalazorThemesPath)')">
    <Copy SourceFiles="@(AvalazorThemeFiles)" DestinationFolder="$(OutputPath)themes\%(RecursiveDir)" SkipUnchangedFiles="true" />
    <Message Importance="High" Text="Avalazor: Copied @(AvalazorThemeFiles->Count()) theme file(s) to output/themes" Condition="'@(AvalazorThemeFiles)' != ''" />
  </Target>

  <!-- Clean generated files -->
  <Target Name="AvalazorCleanGenerated" BeforeTargets="Clean">
    <RemoveDir Directories="$(AvalazorGeneratedPath)" />
  </Target>

</Project>
