<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- Default Configuration if not set -->
    <Configuration Condition="'$(Configuration)' == ''">Debug</Configuration>
    <!-- Determine the path to the build tasks DLL -->
    <!-- Default to the local build output; packaged/alternative setups should override FazorBuildTasksPath externally -->
    <FazorBuildTasksPath Condition="'$(FazorBuildTasksPath)' == ''">$(MSBuildThisFileDirectory)..\bin\$(Configuration)\net8.0\Fazor.Build.dll</FazorBuildTasksPath>
    <FazorGeneratedPath Condition="'$(FazorGeneratedPath)' == ''">$(IntermediateOutputPath)Fazor\Generated\</FazorGeneratedPath>
  </PropertyGroup>

  <!-- UsingTask declarations - assembly will be loaded when tasks are executed -->
  <UsingTask TaskName="Fazor.Build.TranspileRazorTask" AssemblyFile="$(FazorBuildTasksPath)" />
  <UsingTask TaskName="Fazor.Build.CompileScssTask" AssemblyFile="$(FazorBuildTasksPath)" />

  <ItemGroup>
    <!-- Include all .razor files -->
    <FazorRazorFiles Include="**\*.razor" Exclude="$(BaseIntermediateOutputPath)**;$(BaseOutputPath)**;bin\**;obj\**" />
    <!-- Include all .scss files -->
    <FazorScssFiles Include="**\*.scss" Exclude="$(BaseIntermediateOutputPath)**;$(BaseOutputPath)**;bin\**;obj\**" />
  </ItemGroup>

  <!-- Transpile Razor files before BeforeCompile (earlier than CoreCompile) -->
  <Target Name="FazorTranspileRazor" 
          BeforeTargets="BeforeCompile;ResolveReferences" 
          DependsOnTargets="ResolveProjectReferences"
          Inputs="@(FazorRazorFiles)" 
          Outputs="$(FazorGeneratedPath)razor.stamp" 
          Condition="'@(FazorRazorFiles)' != '' AND Exists('$(FazorBuildTasksPath)')">
    <!-- Note: Exists() check is defensive - DLL should exist due to DependsOnTargets="ResolveProjectReferences" -->
    <Message Importance="High" Text="Fazor: Transpiling @(FazorRazorFiles->Count()) Razor file(s)..." />
    <MakeDir Directories="$(FazorGeneratedPath)" />
    
    <TranspileRazorTask 
      RazorFiles="@(FazorRazorFiles)"
      RootNamespace="$(RootNamespace)"
      OutputPath="$(FazorGeneratedPath)"
      UseFolderNamespacing="true">
      <Output TaskParameter="GeneratedFiles" ItemName="FazorGeneratedRazor" />
    </TranspileRazorTask>

    <!-- Add generated files to compilation -->
    <ItemGroup>
      <Compile Include="@(FazorGeneratedRazor)" />
    </ItemGroup>

    <Touch Files="$(FazorGeneratedPath)razor.stamp" AlwaysCreate="true" />
  </Target>

  <!-- Compile SCSS files before Build -->
  <Target Name="FazorCompileScss" BeforeTargets="Build" Inputs="@(FazorScssFiles)" Outputs="$(FazorGeneratedPath)scss.stamp" Condition="'@(FazorScssFiles)' != '' AND Exists('$(FazorBuildTasksPath)')">
    <Message Importance="High" Text="Fazor: Compiling @(FazorScssFiles->Count()) SCSS file(s)..." />
    <MakeDir Directories="$(FazorGeneratedPath)css\" />
    
    <CompileScssTask 
      ScssFiles="@(FazorScssFiles)"
      OutputPath="$(FazorGeneratedPath)css\"
      IncludePaths="$(MSBuildProjectDirectory)">
      <Output TaskParameter="GeneratedFiles" ItemName="FazorGeneratedCss" />
    </CompileScssTask>

    <!-- Copy CSS files to output -->
    <ItemGroup>
      <Content Include="@(FazorGeneratedCss)">
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      </Content>
    </ItemGroup>

    <Touch Files="$(FazorGeneratedPath)scss.stamp" AlwaysCreate="true" />
  </Target>

  <!-- Clean generated files -->
  <Target Name="FazorCleanGenerated" BeforeTargets="Clean">
    <RemoveDir Directories="$(FazorGeneratedPath)" />
  </Target>

</Project>
